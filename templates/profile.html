{% extends "base.html" %}

{% block title %}Profil{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Profil Bilgileri</h1>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Kişisel Bilgiler</h5>
                </div>
                <div class="card-body">
                    <form id="profileForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Ad</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Soyad</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">Kullanıcı Adı</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-posta</label>
                            <input type="email" class="form-control" id="email" readonly>
                            <small class="text-muted">E-posta adresi değiştirilemez</small>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefon</label>
                            <input type="text" class="form-control" id="phone">
                        </div>
                        <div class="mb-3">
                            <label for="region" class="form-label">Bölge</label>
                            <input type="text" class="form-control" id="region">
                        </div>
                        <div class="mb-3">
                            <label for="representativeCode" class="form-label">Temsilci Kodu</label>
                            <input type="text" class="form-control" id="representativeCode" readonly>
                            <small class="text-muted">Temsilci kodu değiştirilemez</small>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="updateProfile()">
                            <i class="fas fa-save"></i> Güncelle
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Şifre Değiştir</h5>
                </div>
                <div class="card-body">
                    <form id="passwordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Mevcut Şifre</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Yeni Şifre</label>
                            <input type="password" class="form-control" id="newPassword" required>
                            <small class="text-muted">En az 6 karakter olmalıdır</small>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Yeni Şifre (Tekrar)</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="button" class="btn btn-warning" onclick="changePassword()">
                            <i class="fas fa-key"></i> Şifre Değiştir
                        </button>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Hesap Bilgileri</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Kullanıcı Adı:</strong></p>
                            <p><strong>Rol:</strong></p>
                            <p><strong>Departman:</strong></p>
                            <p><strong>Hesap Durumu:</strong></p>
                            <p><strong>Kayıt Tarihi:</strong></p>
                            <p><strong>Son Giriş:</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p id="profileUsername">-</p>
                            <p id="profileRole">-</p>
                            <p id="profileDepartment">-</p>
                            <p id="profileStatus">-</p>
                            <p id="profileCreatedAt">-</p>
                            <p id="profileLastLogin">-</p>
                        </div>
                    </div>
                    <div class="mt-3" id="adminActions" style="display:none;">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="softDeleteThisUser()">
                            <i class="fas fa-user-slash"></i> Kullanıcıyı Pasifleştir (Sil)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
    applyViewMode();
});

// Profil bilgilerini yükle
async function loadProfile() {
    try {
        const params = new URLSearchParams(window.location.search);
        const viewUserId = params.get('user_id');
        const url = viewUserId ? (`/auth/profile?user_id=${encodeURIComponent(viewUserId)}`) : '/auth/profile';
        const response = await fetch(url);
        const data = await response.json();
        
        // Form alanlarını doldur
        document.getElementById('firstName').value = data.first_name || '';
        document.getElementById('lastName').value = data.last_name || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('username').value = data.username || '';
        document.getElementById('phone').value = data.phone || '';
        document.getElementById('region').value = data.region || '';
        document.getElementById('representativeCode').value = data.representative_code || '';
        
        // Hesap bilgilerini doldur
        document.getElementById('profileUsername').textContent = data.username || '-';
        document.getElementById('profileRole').textContent = getRoleDisplayName(data.role) || '-';
        document.getElementById('profileDepartment').textContent = data.department_name || 'Atanmamış';
        document.getElementById('profileStatus').innerHTML = data.is_active ? 
            '<span class="badge bg-success">Aktif</span>' : 
            '<span class="badge bg-danger">Pasif</span>';
        document.getElementById('profileCreatedAt').textContent = data.created_at ? 
            new Date(data.created_at).toLocaleDateString('tr-TR') : '-';
        document.getElementById('profileLastLogin').textContent = data.last_login ? 
            new Date(data.last_login).toLocaleString('tr-TR') : '-';
        // Admin ise ve başka kullanıcıya bakıyorsa sil butonunu aç
        try {
            const isAdmin = (document.body.getAttribute('data-is-admin') === 'true');
            const currentUserId = Number(document.body.getAttribute('data-user-id')) || null;
            const params = new URLSearchParams(window.location.search);
            const viewUserId = params.get('user_id');
            if (isAdmin && viewUserId && Number(viewUserId) !== currentUserId) {
                const actions = document.getElementById('adminActions');
                if (actions) { actions.style.display = ''; actions.dataset.userId = String(data.id); }
            }
        } catch (e) {}
        
    } catch (error) {
        console.error('Profil bilgileri yüklenirken hata:', error);
        showAlert('Profil bilgileri yüklenirken hata oluştu', 'danger');
    }
}

// Admin: görüntülenen kullanıcıyı pasifleştir (soft-delete)
async function softDeleteThisUser(){
    try {
        const actions = document.getElementById('adminActions');
        const userId = actions && actions.dataset.userId ? actions.dataset.userId : (new URLSearchParams(window.location.search)).get('user_id');
        if (!userId) { showAlert('Hedef kullanıcı bulunamadı', 'danger'); return; }
        if (!confirm('Bu kullanıcı pasif edilecek ve giriş yapamayacak. Devam edilsin mi?')) return;
        const res = await fetch(`/api/users/${encodeURIComponent(userId)}`, { method: 'DELETE' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'İşlem başarısız');
        showAlert('Kullanıcı pasifleştirildi', 'success');
        // Durum rozetini güncelle
        const st = document.getElementById('profileStatus');
        if (st) st.innerHTML = '<span class="badge bg-danger">Pasif</span>';
    } catch (err) {
        console.error(err);
        showAlert('Kullanıcı pasifleştirilirken hata oluştu', 'danger');
    }
}

// Başka kullanıcı profili görüntüleniyorsa formu salt okunur yap
function applyViewMode(){
    const params = new URLSearchParams(window.location.search);
    const viewUserId = params.get('user_id');
    if (!viewUserId) return;
    const readonlyIds = ['firstName','lastName','username','phone','region'];
    readonlyIds.forEach(id=>{ const el=document.getElementById(id); if(el){ el.readOnly=true; el.classList.add('bg-light'); }});
    // Güncelle ve şifre değiştirme butonlarını gizle
    const updateBtn = document.querySelector('#profileForm button[type="button"]');
    if (updateBtn) updateBtn.style.display='none';
    const pwdBtn = document.querySelector('#passwordForm button[type="button"]');
    if (pwdBtn) pwdBtn.style.display='none';
}

// Rol adını Türkçe olarak getir
function getRoleDisplayName(role) {
    const roleNames = {
        'admin': 'Yönetici',
        'representative': 'Temsilci',
        'user': 'Kullanıcı',
        'department_manager': 'Departman Yöneticisi'
    };
    return roleNames[role] || role;
}

// Profil güncelle
async function updateProfile() {
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const phone = document.getElementById('phone').value;
    const region = document.getElementById('region').value;
    const username = document.getElementById('username').value;
    
    if (!firstName || !lastName) {
        showAlert('Ad ve soyad alanları zorunludur', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/auth/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                first_name: firstName,
                last_name: lastName,
                phone: phone,
                region: region,
                username: username
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('Profil başarıyla güncellendi', 'success');
        } else {
            showAlert(data.error || 'Profil güncellenirken hata oluştu', 'danger');
        }
    } catch (error) {
        console.error('Profil güncellenirken hata:', error);
        showAlert('Profil güncellenirken hata oluştu', 'danger');
    }
}

// Şifre değiştir
async function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showAlert('Tüm şifre alanları zorunludur', 'warning');
        return;
    }
    
    if (newPassword.length < 6) {
        showAlert('Yeni şifre en az 6 karakter olmalıdır', 'warning');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showAlert('Yeni şifreler eşleşmiyor', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('Şifre başarıyla değiştirildi', 'success');
            document.getElementById('passwordForm').reset();
        } else {
            showAlert(data.error || 'Şifre değiştirilirken hata oluştu', 'danger');
        }
    } catch (error) {
        console.error('Şifre değiştirilirken hata:', error);
        showAlert('Şifre değiştirilirken hata oluştu', 'danger');
    }
}

// Alert göster
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}

